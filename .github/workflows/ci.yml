name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    # Evitar ejecutar CI en PRs de Dependabot automáticamente (opcional)
    # Los PRs de Dependabot seguirán ejecutando CI, pero puedes limitar workflows secundarios

env:
  PHP_VERSION: '8.5'
  POSTGRES_VERSION: '18'
  REDIS_VERSION: '7'

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, redis, gd, intl, zip, opcache
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run Laravel Pint (Lint)
        run: ./vendor/bin/pint --test
        continue-on-error: false

      - name: Run PHPStan (Static Analysis)
        run: ./vendor/bin/phpstan analyse --level=5 --memory-limit=2G
        continue-on-error: false

  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: apygg_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:${{ env.REDIS_VERSION }}
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    env:
      APP_ENV: testing
      APP_KEY: base64:test-key-for-ci-pipeline-only-not-for-production-use
      DB_CONNECTION: pgsql
      DB_HOST: localhost
      DB_PORT: 5432
      DB_DATABASE: apygg_test
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      JWT_SECRET: test-jwt-secret-for-ci-only
      BROADCAST_CONNECTION: log

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, redis, gd, intl, zip, opcache
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare Laravel application
        run: |
          cp .env.example .env || true
          php artisan key:generate --force
          php artisan config:clear
          php artisan cache:clear

      - name: Run database migrations
        run: php artisan migrate --force --env=testing

      - name: Run Pest tests with coverage
        run: ./vendor/bin/pest --coverage --min=0
        continue-on-error: false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  security:
    name: Security Scan (Composer Audit)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, redis

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-dev

      - name: Run Composer audit (quick scan)
        run: |
          composer audit --format=json > audit.json || true
          if [ -f audit.json ]; then
            echo "Vulnerability scan completed"
            cat audit.json | jq '.' || true
          fi
        continue-on-error: true

  build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/app/Dockerfile
          push: false
          tags: apygg:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            USER_ID=1000
            GROUP_ID=1000

      - name: Test Docker image
        run: |
          docker run --rm apygg:ci-test php --version
          docker run --rm apygg:ci-test php artisan --version
          docker run --rm apygg:ci-test composer --version

  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ CI Pipeline failed"
            exit 1
          fi
          echo "✅ All CI checks passed"
