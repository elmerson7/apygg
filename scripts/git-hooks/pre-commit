#!/bin/bash
#
# Pre-commit Hook
# Ejecuta validaciones antes de permitir un commit
#
# Validaciones:
# 1. Sintaxis PHP (php -l)
# 2. Formateo autom√°tico con Pint
# 3. Detecci√≥n de dd(), dump(), console.log, var_dump
# 4. Tests r√°pidos (opcional, puede deshabilitarse)

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuraci√≥n
ENV=${ENV:-dev}
DC="docker compose --project-name apygg --profile ${ENV}"
CONTAINER_NAME="apygg-app-${ENV}"
SKIP_TESTS=${SKIP_TESTS:-false}

# Verificar si Docker est√° corriendo
if ! docker ps >/dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Docker no est√° corriendo. Saltando validaciones de pre-commit.${NC}"
    exit 0
fi

# Verificar si el contenedor est√° corriendo
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Contenedor ${CONTAINER_NAME} no est√° corriendo. Saltando validaciones de pre-commit.${NC}"
    echo -e "${YELLOW}   Ejecuta: make up${NC}"
    exit 0
fi

# Obtener archivos PHP staged
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(php)$' || true)

# Si no hay archivos PHP staged, salir
if [ -z "$STAGED_PHP_FILES" ]; then
    echo -e "${GREEN}‚úì No hay archivos PHP para validar${NC}"
    exit 0
fi

echo -e "${GREEN}üîç Ejecutando validaciones de pre-commit...${NC}"
echo ""

# Contador de errores
ERRORS=0

# 1. Validar sintaxis PHP
echo -e "${GREEN}[1/4] Validando sintaxis PHP...${NC}"
for FILE in $STAGED_PHP_FILES; do
    if [ -f "$FILE" ]; then
        if ! ${DC} exec -T app php -l "$FILE" >/dev/null 2>&1; then
            echo -e "${RED}‚úó Error de sintaxis en: $FILE${NC}"
            ${DC} exec -T app php -l "$FILE" 2>&1 | head -5
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Errores de sintaxis encontrados. Corrige los errores antes de hacer commit.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Sintaxis PHP v√°lida${NC}"
echo ""

# 2. Detectar c√≥digo de debug (dd, dump, console.log, var_dump)
echo -e "${GREEN}[2/4] Buscando c√≥digo de debug...${NC}"
DEBUG_PATTERNS=(
    '\bdd\s*\('
    '\bdump\s*\('
    '\bvar_dump\s*\('
    'console\.log\s*\('
)

FOUND_DEBUG=false
for FILE in $STAGED_PHP_FILES; do
    if [ -f "$FILE" ]; then
        for PATTERN in "${DEBUG_PATTERNS[@]}"; do
            if grep -nE "$PATTERN" "$FILE" >/dev/null 2>&1; then
                if [ "$FOUND_DEBUG" = false ]; then
                    echo -e "${RED}‚úó Se encontr√≥ c√≥digo de debug en los archivos staged:${NC}"
                    FOUND_DEBUG=true
                fi
                echo -e "${RED}  - $FILE${NC}"
                grep -nE "$PATTERN" "$FILE" | sed 's/^/    /' || true
                ERRORS=$((ERRORS + 1))
            fi
        done
    fi
done

if [ "$FOUND_DEBUG" = true ]; then
    echo ""
    echo -e "${RED}‚ùå Por favor, elimina el c√≥digo de debug (dd, dump, var_dump, console.log) antes de hacer commit.${NC}"
    echo -e "${YELLOW}   Si necesitas hacer commit con debug, usa: git commit --no-verify${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì No se encontr√≥ c√≥digo de debug${NC}"
echo ""

# 3. Formatear c√≥digo con Pint autom√°ticamente
echo -e "${GREEN}[3/4] Formateando c√≥digo con Pint...${NC}"
PINT_FILES=$(echo "$STAGED_PHP_FILES" | tr '\n' ' ')
if [ -n "$PINT_FILES" ]; then
    # Ejecutar Pint solo en archivos staged
    if ${DC} exec -T app ./vendor/bin/pint $PINT_FILES >/dev/null 2>&1; then
        # Si Pint modific√≥ archivos, agregarlos al staging
        MODIFIED_FILES=$(git diff --name-only | grep -E '\.(php)$' || true)
        if [ -n "$MODIFIED_FILES" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Pint formate√≥ algunos archivos. Agreg√°ndolos al staging...${NC}"
            echo "$MODIFIED_FILES" | xargs git add 2>/dev/null || true
        fi
        echo -e "${GREEN}‚úì C√≥digo formateado${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Pint encontr√≥ problemas de formato. Revisa los archivos.${NC}"
        echo -e "${YELLOW}   Ejecuta: make pint${NC}"
    fi
fi
echo ""

# 4. Ejecutar tests (opcional, puede ser lento)
if [ "$SKIP_TESTS" != "true" ]; then
    echo -e "${GREEN}[4/4] Ejecutando tests r√°pidos...${NC}"
    echo -e "${YELLOW}   (Puedes saltar tests con: SKIP_TESTS=true git commit)${NC}"
    
    # Ejecutar solo tests relacionados con archivos modificados si es posible
    # Por ahora ejecutamos todos los tests, pero puede optimizarse
    if ${DC} exec -T app composer test >/dev/null 2>&1; then
        echo -e "${GREEN}‚úì Tests pasaron${NC}"
    else
        echo -e "${RED}‚úó Tests fallaron${NC}"
        echo -e "${YELLOW}   Ejecuta manualmente: make test${NC}"
        echo -e "${YELLOW}   O salta tests: SKIP_TESTS=true git commit${NC}"
        ERRORS=$((ERRORS + 1))
    fi
else
    echo -e "${YELLOW}[4/4] Tests saltados (SKIP_TESTS=true)${NC}"
fi

echo ""

# Resumen
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Todas las validaciones pasaron. Procediendo con el commit...${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Se encontraron $ERRORS error(es). Corrige los problemas antes de hacer commit.${NC}"
    echo -e "${YELLOW}   Para saltar validaciones (no recomendado): git commit --no-verify${NC}"
    exit 1
fi
